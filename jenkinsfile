pipeline {
    agent any

    environment {
        VERSION = "1.0.${BUILD_NUMBER}"
        PATH = "${PATH}:${getSonarPath()}:${getDockerPath()}"
        // RUNNER
    }

    stages {
        stage ('Sonarcube Scan') {
        steps {
         script {
          scannerHome = tool 'sonarqube'
        }
        withCredentials([string(credentialsId: 'SONAR_TOKEN', variable: 'SONAR_TOKEN')]){
        withSonarQubeEnv('SonarQubeScanner') {
          sh " ${scannerHome}/bin/sonar-scanner \
          -Dsonar.projectKey=sema-webiste-scan   \
          -Dsonar.host.url=http://54.160.209.113:9000 \
          -Dsonar.login=${SONAR_TOKEN} "
        }
        }
        }

}

//  stage('Quality Gate') {
//             steps {
//                 timeout(time: 7, unit: 'MINUTES') {
//                     waitForQualityGate abortPipeline: true
//             }
//             }
//         }


  stage ('Build Docker Image and Push To ECR') {
          steps {
              sh "/usr/bin/docker build  --tag semasite-image:latest ."
          }
        }

  stage ('Starting Docker Image for Testing') {
          steps {
              sh "/usr/bin/docker run --name semasite-cont-latest  -p 80:80 -d semasite-image:latest"
          }
        }


//   stage ('Deployment Tear Down Prompt ') {
//               steps {
//                 script {
//                 def userInput = input(id: 'confirm', message: 'Please Test semasite Image Deployment. Should I delete now?', parameters: [ [$class: 'BooleanParameterDefinition', defaultValue: false, description: 'Tear Down App', name: 'confirm'] ])
//              }
//              sh " docker stop semasite-cont-$VERSION "
//              sh " docker rm  semasite-cont-$VERSION "
//            }
//         }

    }

}



def getSonarPath(){
        def SonarHome= tool name: 'sonarqube', type: 'hudson.plugins.sonar.SonarRunnerInstallation'
        return SonarHome
    }
def getDockerPath(){
        def DockerHome= tool name: 'docker-inst', type: 'dockerTool'
        return DockerHome
    }
    
